# setup

```{r setup, include=FALSE}
# Check and install required packages if necessary
packages <- c("openair", "openairmaps", "leaflet", "dplyr", "chron", "timeDate", "data.table", "hexbin","ggplot2","reshape2", "lubridate", "tidyr", "gridExtra")
install.packages(packages[!sapply(packages, requireNamespace, quietly = TRUE)])

# Load required packages for data manipulation and analysis
invisible(sapply(packages, library, character.only = TRUE))

# Set options
knitr::opts_chunk$set(echo = FALSE, message = FALSE)


```

```{r}
# Load data frame
load("./graphableData.RData")
mod_met$sn<- mod_met$sn.x
my_df  <- mod_met


target_cols <- c("pm1", "pm25", "pm10", "co", "no", "no2", "o3")
# Filtering out any row which is negative. 
negative_rows <- my_df[apply(my_df[, target_cols], 1, function(row) any(row < 0, nasddfsfsdf.rm = TRUE)), ] #df with only negative rows
my_df_filtered <- my_df[!apply(my_df[, target_cols], 1, function(row) any(row < 0, na.rm = TRUE)), ] #my_df now has no negative values in the specified columns)

```
# Sanity check & Thresholds
```{r}
unique_sensors <- unique(my_df$sn)
unique_names <- unique(my_df$sitename)

#for (sensor in unique_sensors) {
#data_for_sensor <- my_df %>% filter(sn == sensor)
#openair::timePlot(data_for_sensor, pollutant = c("pm1", "pm25", "pm10", "no", "no2", "co", "o3"), y.relation = #"free", main=sensor)
#}

#226 & 221 have notes saying that 221 has just funny looking readings while

print(unique_sensors)
print(unique_names)


# There are a lot of reasons why particular values in pollutant concentration may be untrustworthy. Namely, when power cycles in a sensor with electrochemical cells, concentration values are biased high until electrical currents stabilize. We'll use evidence we see in the timePlot from above to set thresholds above which we'll remove values. The values below are at least a reasonable starting point.

thresholds <- c(pm10 = 5000, 
                pm25 = 200,
                pm1 = 150,
                no = 300,
                no2 = 400,
                co = 3000,
                o3 = 200      
                )




for (pollutant in names(thresholds)) {
  threshold <- thresholds[[pollutant]]

  # Replace values above threshold with NA
  my_df_filtered[, pollutant][my_df_filtered[, pollutant] > threshold] <- NA

  # Replace values below zero with NA
  my_df_filtered[, pollutant][my_df_filtered[, pollutant] < 0] <- NA

}



source("./main_helpers.r")
unique_sensors <- unique(my_df$sn)

data_particulates = computeSummary(my_df_filtered, unique_sensors, c("pm1", "pm25", "pm10"))

summary_df <- data_particulates %>%
  mutate(Group = case_when(
    Sensor %in% commuter_sensors ~ "Commuter",
    Sensor %in% publicbus_sensors ~ "Public Buses",
    Sensor %in% schoolbus_sensors ~ "School Buses",
  Sensor %in% construction_sensors ~ "Construction",
    TRUE ~ "Other"
  ))

```

# Percentile Heatmaps
```{r}
source("./main_helpers.r")

percentileHeatmap(my_df_filtered, gas_sensors, gas_pollutants)
percentileHeatmap(my_df_filtered, unique_sensors, particulate_pollutants)

```
# Color Dot Maps for all sensors for chemical/gas pollutant types
Note: you can't use a for loop in this because then the plots don't actually appear. 
```{r}
source("./main_helpers.r")

data_particulates = computeFullSummary(my_df_filtered, unique_sensors,gas_pollutants)

generateNetworkMap(data_particulates, "Mean", "co")
generateNetworkMap(data_particulates, "Median", "co")
generateNetworkMap(data_particulates, "P25", "co")
generateNetworkMap(data_particulates, "P75", "co")
generateNetworkMap(data_particulates, "P95", "co")
  
generateNetworkMap(data_particulates, "Mean", "no")
generateNetworkMap(data_particulates, "Median", "no")
generateNetworkMap(data_particulates, "P25", "no")
generateNetworkMap(data_particulates, "P75", "no")
generateNetworkMap(data_particulates, "P95", "no")

generateNetworkMap(data_particulates, "Mean", "o3")
generateNetworkMap(data_particulates, "Median", "o3")
generateNetworkMap(data_particulates, "P25", "o3")
generateNetworkMap(data_particulates, "P75", "o3")
generateNetworkMap(data_particulates, "P95", "o3")

generateNetworkMap(data_particulates, "Mean", "no2")
generateNetworkMap(data_particulates, "Median", "no2")
generateNetworkMap(data_particulates, "P25", "no2")
generateNetworkMap(data_particulates, "P75", "no2")
generateNetworkMap(data_particulates, "P95", "no2")

```
# Color Dot Maps for all sensors for PMs
```{r}
data_particulates = computeFullSummary(my_df_filtered, unique_sensors,particulate_pollutants)

generateNetworkMap(data_particulates, "Mean", "pm1")
generateNetworkMap(data_particulates, "Median", "pm1")
generateNetworkMap(data_particulates, "P25", "pm1")
generateNetworkMap(data_particulates, "P75", "pm1")
generateNetworkMap(data_particulates, "P95", "pm1")

generateNetworkMap(data_particulates, "Mean", "pm25")
generateNetworkMap(data_particulates, "Median", "pm25")
generateNetworkMap(data_particulates, "P25", "pm25")
generateNetworkMap(data_particulates, "P75", "pm25")
generateNetworkMap(data_particulates, "P95", "pm25")

generateNetworkMap(data_particulates, "Mean", "pm10")
generateNetworkMap(data_particulates, "Median", "pm10")
generateNetworkMap(data_particulates, "P25", "pm10")
generateNetworkMap(data_particulates, "P75", "pm10")
generateNetworkMap(data_particulates, "P95", "pm10")




```


# Bar Charts
```{r}
source("./main_helpers.r")
data_particulates = computeFullSummary(my_df_filtered, unique_sensors,particulate_pollutants)

summary_df <- data_particulates %>%
  mutate(Group = case_when(
    Sensor %in% commuter_sensors ~ "Commuter",
    Sensor %in% publicbus_sensors ~ "Public Buses",
    Sensor %in% schoolbus_sensors ~ "School Buses",
  Sensor %in% construction_sensors ~ "Construction",
    TRUE ~ "Other"
  ))



for (pollutant in particulate_pollutants){
  barCharts(summary_df, pollutant, "Mean", include_sd = TRUE, order_by = "overall")
barCharts(summary_df, pollutant, "Mean", include_sd = TRUE)
  
}
data_particulates = computeFullSummary(my_df_filtered, unique_sensors,gas_pollutants)

summary_df <- data_particulates %>%
  mutate(Group = case_when(
    Sensor %in% commuter_sensors ~ "Commuter",
    Sensor %in% publicbus_sensors ~ "Public Buses",
    Sensor %in% schoolbus_sensors ~ "School Buses",
  Sensor %in% construction_sensors ~ "Construction",
    TRUE ~ "Other"
  ))



for (pollutant in gas_pollutants){
  barCharts(summary_df, pollutant, "Mean", include_sd = TRUE, order_by = "overall")
}


```
# Polar Maps
```{r}
polarMap(my_df_filtered,
         pollutant = "pm1", 
         key.position = "bottom",
         key.header = "PM1 (ug/m3)", 
         key.footer = NULL, 
         x = "ws",
         latitude = "lat",
         longitude = "lon", 
         provider = "OpenStreetMap",
         limits = c(0, 15),
         cols = "jet",
         alpha = 0.8,
         key = TRUE,
         iconWidth = 200,
         iconHeight = 200,
         fig.width = 4,
         fig.height = 4,
         statistic = "weighted.mean"
         )
```

# Annulus Plot
```{r}

Annulus Plot(my_df_filtered,
         pollutant = "pm1",
         key.position = "bottom",
         key.header = "NO (ppb)",
         latitude = "lat",
         longitude = "lon",
         provider = "OpenStreetMap",
         limits = c(0, 15),
         cols = "jet",
         key = TRUE,
         )

```


```{r}


```
# Duty Cycle Graph for One Sensor
```{r}


df_all_sensor  <- my_df_filtered %>% filter(sn == "MOD-00026")
timePlot(df_all_sensor, pollutant="co")
dutyCycleSensor("MOD-00026", "co", my_df )


```

# Duty Cycle Graphs (All sensors together)
```{r}


sensors <- unique(my_df$sn)
dutyCycleMultipleSensors( "pm10", my_df, sensors )
dutyCycleMultipleSensors( "pm25", my_df, sensors )
dutyCycleMultipleSensors( "pm1", my_df,sensors )
sensorsdutyCycleMultipleSensorsas.character(gas_sensors)

dutyCycleMultipleSensors( "co", my_df,sensors )
dutyCycleMultipleSensors( "o3", my_df,sensors )
dutyCycleMultipleSensors( "no", my_df,sensors )
dutyCycleMultipleSensors( "no2", my_df,sensors )

```
# TimeVariation Diurnals
```{r}

for (sensor in unique_sensors) {
  timeVariationByDay(sensor, particulate_pollutants, my_df_filtered)
    timeVariationByDay(sensor, gas_pollutants, my_df_filtered)

  
}

```
# Calendar Plots (Exported PNGS)
```{r}
unique_sensors <- unique(my_df$sn)

for (sensor in unique_sensors) {
  for (pollutant in gas_pollutants) {
    filename <- paste0("calendar_", sensor, "_", pollutant, ".png")

    png(filename, width = 1600, height = 1000)

    # Filter data for the specific sensor
    data_for_sensor <- my_df_filtered %>% filter(sn == sensor)

    # Skip if no data
    if (nrow(data_for_sensor) == 0 || all(is.na(data_for_sensor[[pollutant]]))) next

    # Set title
    title <- paste("Calendar Plot for", sensor, "-", pollutant)
    
    # Create plot
    openair::calendarPlot(
      data_for_sensor, 
      pollutant = pollutant, 
      limits = c(0, median(data_for_sensor[[pollutant]], na.rm = TRUE) + 
                    sd(data_for_sensor[[pollutant]], na.rm = TRUE)), 
      main = title, 
      key.header = paste(pollutant ,"µg/m³"), 
      key.position = "right"
    )
    dev.off()

  }
}


```


``` {r} 
# High and low thresholds
pm1_low_threshold = 2  # made up guideline
pm1_high_threshold = 5  # made up guideline
 
pm25_low_threshold = 5 # who annual guideline
pm25_high_threshold = 12 # who hourly guideline
 
pm10_low_threshold = 15 # who annual guideline
pm10_high_threshold = 35 # who hourly guideline

source("./helpers.r")

# EPA Standards: https://www.epa.gov/criteria-air-pollutants/naaqs-table
pollutants_1 <- c("co", "no2", "o3", "pm25", "pm10")
limits_1 <- c(9*1000, # 8 hours (ppm->ppb)
              53, # 1 year (ppb)
              0.070*1000, # 8 hours (ppm->ppb)
              35, # 24 hours (ug/m3)
              150) #24 hours (ug/m3)
EPA_standards <- data.frame(pollutants_1, limits_1)

# WHO Standards: https://www.who.int/news-room/feature-stories/detail/what-are-the-who-air-quality-guidelines
# Conversions: https://www.breeze-technologies.de/blog/air-pollution-how-to-convert-between-mgm3-%C2%B5gm3-ppm-ppb/
pollutants_2 <- c("co", "no2", "o3", "pm25", "pm10")
limits_2 <- c(4*1000*1.15, # 24 hours (mg/m3->ppb)
              10*1.88, # 1 year (ug/m3->ppb)
              100*1.96, # 8 hours 
              15, # 24 hours (ug/m3)
              45) #24 hours (ug/m3)
WHO_standards <- data.frame(pollutants_2, limits_2)

plots <- plot_grouped_pm_trends(my_df_filtered, EPA_standards, WHO_standards)
for (plot in plots) {
  print(plot)
}

```

```{r}


```